<html>
    <head>
        <title>INFO 4310 - Final Project</title>

        <!-- Loading scripts -->
        <script src="https://d3js.org/d3.v5.min.js"></script>
  

        <!-- Styling -->
        <style>

            body {
                background-color: #2C2D51;
                color: white;
                font-family: Verdana, Geneva, Tahoma, sans-serif;
            }

            .tooltip {
                pointer-events: none;
            }

            #country-container {
                display: flex;
                flex-direction: row;
                align-items: flex-start;
                justify-content: center;
            }
            #countries-selected {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }

            #area-chart {
                margin-left: 200px;
                margin-top: 100px;
            }

         

        </style>
    </head>

    <body>

        <div class = "top">
            <div class="header">
                <h1 class="page-title"> Olympics Match-Up </h1>
                <p>by Sydney Wan (ssw73)</p>
            </div>
        </div>

        <div id="container">
            <h3>Select your countries.</h3>
            <div id="country-container">
                <svg id="map" height="600" width="900"></svg>    
                <div id = "countries-selected">
                    <svg id="country-select"  height="250" width="500"></svg>
                    <div id="country-select-buttons">
                        <button id="go">Go!</button>
                        <button id="reset" style="width:50">Reset</button>
                    </div>                
                </div>
            </div>
            <div id = "area-chart">
                <h3>Number of medals earned by year</h3>
                <svg id="area-chart-plot" height="600" width="900"></svg>
                <svg></svg>


            </div>
            

        </div>
        
        
        <script>
            const requestData = async function() {
                //load data
                let countryData = await d3.json("countries.geo.json");
                const olympicData = await d3.csv("athlete_events.csv", d3.autoType);

                console.log(countryData);
                console.log(olympicData);

                //define basic variables
                const svg = d3.select("#map");
                const svg_countries = d3.select("#country-select");
                const width = svg.attr("width");
                const height = svg.attr("height");
                const margin = { top: 20, right: 20, bottom: 20, left:20};
                const mapWidth = width - margin.left - margin.right;
                const mapHeight = height - margin.top - margin.bottom;
                const map = svg.append("g")
                                .attr("transform","translate("+margin.left+","+margin.top+")");

                const svg_area = d3.select("#area-chart-plot");
                const chartMargin = { top: 20, right: 20, bottom: 20, left:30};
                const area_width = svg_area.attr("width") - chartMargin.left - chartMargin.right; 
                const area_height = svg_area.attr("height") - chartMargin.top - chartMargin.bottom;


                //create projections
                var projection = d3.geoMercator().fitSize([mapWidth, mapHeight + 30], countryData);
                var path = d3.geoPath().projection(projection);

                //get counts of athletes per country
                var athleteCounts = [];
                olympicData.forEach( d => {
                    if(athleteCounts.some(e => e.country === d.Team)) {
                        athleteCounts.forEach( obj => {
                            if (obj.country === d.Team) {
                                obj.count += 1;
                            }
                        })
                    }
                    else {
                        athleteCounts.push({
                        "country": d.Team,
                        "count": 1
                    })

                    }
                    
                })
                
                //define map color scale and create map
                let valueExtent = d3.extent(athleteCounts, d => d.count);
                const colorScale = d3.scaleSequential(d3.interpolateViridis).domain(valueExtent);

                map.selectAll("path.country").data(countryData.features)
                .join("path")
                .attr("class", "country")
                .attr("d", path)
                .attr("fill", function (d) { 
                    var result = athleteCounts.filter(obj => {
                        return d.properties.name === obj.country;
                    });
                    if (result.length === 0) { return "none";}
                    else { return colorScale(result[0].count); }
                })
                .attr("stroke", "white")
                .on('mouseover', mouseEntersState)
                .on('mouseout', mouseLeavesState)
                .on("click", mouseClickEvent);



                //define zoom functionality for map
                var zoom = d3.zoom()
                  .scaleExtent([1,10])
                  .translateExtent([[-50,-50],[mapWidth+50,mapHeight+50]])
                  .on("zoom", zoomMap);
                  
                svg.call(zoom);

                // Setting up tooltip to display map country and counts
                const tooltipWidth_CONST = 120;
                const tooltipHeight_CONST = 40;
                const txt_CONST = 14;
                let tooltipWidth = tooltipWidth_CONST;
                let tooltipHeight = tooltipHeight_CONST;

                let tooltip = map.append("g")
                           .attr("class", "tooltip")
                           .attr("visibility", "hidden"); 
          
                tooltip.append("rect")
                        .attr("fill", "white")
                        .attr("opacity", 0.9)
                        .attr("x", -tooltipWidth / 2.0)
                        .attr("y", 0)
                        .attr("width", tooltipWidth)
                        .attr("height", tooltipHeight);
                
                let txt = tooltip.append("text")
                                .attr("fill", "#7a0177")
                                .attr("text-anchor", "middle")
                                .attr("alignment-baseline", "hanging")
                                .attr("x", 0)
                                .attr("y", 2)
                                .style("font-weight", 600)
                                .style("font-size", txt_CONST)
                                .style("", "white");
                
                let txt2 = tooltip.append("text")
                                    .attr("fill", "#7a0177")
                                    .attr("text-anchor", "middle")
                                    .attr("alignment-baseline", "hanging")
                                    .attr("x", 0)
                                    .attr("y", 22)
                                    .style("font-size", txt_CONST);


                //defining country tooltip to display selected countries
                let country_tooltip = svg_countries.append("g")
                                                    .attr("class", "countries")
                                                    .attr("transform","translate("+margin.left+","+margin.top+")");
                country_tooltip.append("text")
                                .attr("fill", "white")
                                .style("text-anchor", "middle")
                                .attr("alignment-baseline", "hanging")
                                .attr("x", 250)
                                .attr("y", 100)
                                .attr("font-weight", 800)
                                .attr("font-size", 30)
                                .text('vs.');

                let country1 = country_tooltip.append("text").text("");
                let country2 = country_tooltip.append("text").text("")
                let countriesSelected = new Set();
                let warning = null;
                d3.select("#reset").on("click", resetCountries);
                d3.select("#go").on("click", populateCharts);

                function resetCountries() {
                    
                    countriesSelected = new Set();
                    if (warning !== null) {
                        warning.html("");
                        warning = null;

                    }
                    country1.html("");
                    country2.html("");
                    country1 = country_tooltip.append("text")
                                            .attr("fill", "gray")
                                            .style("text-anchor", "middle")
                                            .attr("alignment-baseline", "hanging")
                                            .attr("x", 250)
                                            .attr("y", 50)
                                            .attr("font-weight", 800)
                                            .attr("font-size", 40)
                                            .text('[Select Country]');
                    country2 = country_tooltip.append("text")
                                                .attr("fill", "gray")
                                                .style("text-anchor", "middle")
                                                .attr("alignment-baseline", "hanging")
                                                .attr("x", 250)
                                                .attr("y", 150)
                                                .attr("font-weight", 800)
                                                .attr("font-size", 40)
                                                .text('[Select Country]');

                    //reset area chart
                    svg_area.html("");
                }

                resetCountries();

                function populateCharts() {
                    if (countriesSelected.size < 2) { return; } //if not all countries are selected

                    document.getElementById("area-chart-plot").scrollIntoView({behavior: "smooth"});


                    //filtering data to the selected countries
                    let filteredData = olympicData.filter(obj => {
                        return countriesSelected.has(obj.Team);
                    });

                    //creating data for each country's medal count by year
                    var medalData = [];
                    filteredData.forEach( d => {
                        if(medalData.some(e => e.country === d.Team && e.year === d.Year)) {
                            medalData.forEach( obj => {
                                if (obj.country === d.Team && obj.year === d.Year) {
                                    obj.count += 1;
                                }
                            })
                        }
                        else {
                            medalData.push({
                            "country": d.Team,
                            "year": d.Year,
                            "count": 1
                        })

                        }
                    })


                    //building area chart and axes
                    let areaChart = svg_area.append("g")
                                            .attr("transform", "translate(" + chartMargin.left + "," + chartMargin.top + ")");
                    const yAxisArea = svg_area.append("g").attr("transform",`translate(${chartMargin.left-2},${chartMargin.top})`);
                    const xAxisArea = svg_area.append("g").attr("transform",`translate(${chartMargin.left},${area_height+2+chartMargin.top})`);


                    //x-axis
                    var x_extent = d3.extent(medalData, function(d) { return d.year; })
                    var xScale = d3.scaleLinear()
                            .domain(x_extent)
                            .range([ 0, area_width - 20 ]);
                    let bottomAxis = d3.axisBottom(xScale).tickFormat(d3.format("d"));;

                    xAxisArea.append("g")
                            .call(bottomAxis)
                            .selectAll("text")
                            .attr("fill", "#e3e3e3");

                    //y-axis
                    const y_extent = d3.extent(medalData, d => d.count);
                    const yScale = d3.scaleLinear().domain(y_extent).range([area_height-10, 10]);
                    let yAxis = d3.axisLeft(yScale); 
                    yAxisArea.append("g").attr("class", "y axis").call(yAxis).selectAll("text").attr("fill", "#e3e3e3");


                    //creating actual area chart
                    var selectedCountriesSorted = Array.from(countriesSelected);

                    //if the second country selected has more medals, the order in the array is swapped so area chart prints nicer
                    if (athleteCounts.find(item => item.country === selectedCountriesSorted[0]).count < athleteCounts.find(item => item.country === selectedCountriesSorted[1]).count) {
                        console.log("first country has less medals");
                        selectedCountriesSorted = selectedCountriesSorted.reverse();
                    }

                    //plot country 1
                    const country1_data = medalData.filter((d) => d["country"] == Array.from(selectedCountriesSorted)[0]).sort((a, b) => a.year - b.year);
                    console.log(country1_data);
                    areaChart.append("path")
                            .datum(country1_data)
                            .attr("fill", "#cce5df")
                            .attr("stroke", "#69b3a2")
                            .attr("stroke-width", 1.5)
                            .attr("opacity", 1)
                            .attr("d", d3.area()
                                .curve(d3.curveMonotoneX)
                                .x(function(d) { return xScale(d.year) })
                                .y0(yScale(0))
                                .y1(function(d) { return yScale(d.count) })
                            )
                    
                    //plot country 2
                    const country2_data = medalData.filter((d) => d["country"] == Array.from(selectedCountriesSorted)[1]).sort((a, b) => a.year - b.year);
                    console.log(country2_data);
                    areaChart.append("path")
                            .datum(country2_data)
                            .attr("fill", "#DEB5EA")
                            .attr("stroke", "#C480D8")
                            .attr("stroke-width", 1.5)
                            .attr("opacity", 0.7)
                            .attr("d", d3.area()
                                .curve(d3.curveMonotoneX)
                                .x(function(d) { return xScale(d.year) })
                                .y0(yScale(0))
                                .y1(function(d) { return yScale(d.count) })
                            )
            
                }
                


                function mouseEntersState() {
                    tooltip.style("visibility", "visible")
                    
                    let country = d3.select(this);
                    let countryName = country.datum().properties.name;
                    let countryData = athleteCounts.filter(obj => {
                        return countryName === obj.country;
                    });
                    let countryCount = 0;
                    if (countryData.length != 0) { 
                        countryCount = countryData[0].count;}

                    txt.text(countryName);
                    txt2.text(countryCount);

                    let bounds = path.bounds(country.datum());
                    let xPos = (bounds[0][0] + bounds[1][0]) / 2.0;
                    let yPos = bounds[1][1] - 15;
                    
                    tooltip.attr("transform", `translate(${xPos},${yPos})`);

                }

                function mouseLeavesState() {
                    tooltip.style("visibility", "hidden");

                    
                }

                function mouseClickEvent() {
                    let country = d3.select(this);
                    let countryName = country.datum().properties.name;
                    let countryData = athleteCounts.filter(obj => {
                        return countryName === obj.country;
                    });
                    

                    //error handling: either country has no athletes or user selects already selected country
                    if (countryData[0].count === 0) { return; }
                    if (countriesSelected.has(countryName)) { return; }

                    //accounting for if a user selects new countries but both slots are full
                    if (countriesSelected.size < 2) {
                        countriesSelected.add(countryName);
                    }

                    //change country names
                    if (countriesSelected.size === 1) {
                        country1.html("");
                        country1 = country_tooltip.append("text")
                                              .attr("fill", "white")
                                              .style("text-anchor", "middle")
                                              .attr("alignment-baseline", "hanging")
                                              .attr("x", 250)
                                              .attr("y", 50)
                                              .attr("font-weight", 800)
                                              .attr("font-size", 40)
                                              .text(countryName);

                    }
                    else if (countriesSelected.size === 2) {
                        country2.html("");
                        country2 = country_tooltip.append("text")
                                              .attr("fill", "white")
                                              .style("text-anchor", "middle")
                                              .attr("alignment-baseline", "hanging")
                                                .attr("x", 250)
                                                .attr("y", 150)
                                                .attr("font-weight", 800)
                                                .attr("font-size", 40)
                                              .text(countryName);

                    }
                    else if (warning === null){
                        warning = country_tooltip.append("text")
                                        .attr("fill", "red")
                                        .attr("text-anchor", "middle")
                                        .attr("x", 200)
                                        .attr("y", 250)
                                        .attr("font-weight", 800)
                                        .text("Press Reset to change countries");

                    }
                }

                function zoomMap() {    
                    map.attr("transform", d3.event.transform);
                    tooltipHeight = tooltipHeight / d3.event.transform.k;
                    tooltipWidth = tooltipWidth / d3.event.transform.k;
                    tooltip.selectAll("rect")
                            .attr("height", tooltipHeight_CONST / d3.event.transform.k  )
                            .attr("width", tooltipWidth_CONST / d3.event.transform.k  );
                    tooltip.selectAll("text").style("font-size", txt_CONST / d3.event.transform.k );
                }

            }

            requestData();
            

            

            
        </script>

    </body>
</html>